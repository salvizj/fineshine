---
import { languageOptions } from "../i18n/ui"
import type { LanguageCode } from "../i18n/utils"

const { languageCode } = Astro.props as { languageCode: LanguageCode }
const otherLanguageCodes = Object.keys(languageOptions).filter(
	(code) => code !== languageCode
)
---

<div class="relative inline-block">
	<details class="cursor-pointer language-selector">
		<summary
			class="list-none flex items-center gap-2 bg-white dark:bg-gray-800 px-3 py-2 rounded border border-gray-300 dark:border-gray-700"
		>
			<span>{languageCode.toUpperCase()}</span>
			<svg
				width="10"
				height="6"
				viewBox="0 0 10 6"
				class="dropdown-arrow"
			>
				<path
					d="M1 1L5 5L9 1"
					stroke="currentColor"
					stroke-width="1.5"
					fill="none"></path>
			</svg>
		</summary>
		<ul
			class="absolute mt-2 left-0 w-full rounded py-1 z-10 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800"
		>
			{
				otherLanguageCodes.map((code) => (
					<li>
						<a
							href={`/${code}/`}
							class="block px-4 py-2 transition-colors duration-150 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100"
							data-lang-code={code}
						>
							{code.toUpperCase()}
						</a>
					</li>
				))
			}
		</ul>
	</details>
</div>

<script>
	import type { LanguageCode } from "../i18n/utils"
	import { setCookie } from "../utils/cookie.js"

	function onLanguageSelected(
		languageCode: LanguageCode,
		redirectLink: string
	) {
		setCookie("lang", languageCode)
		window.location.href = redirectLink
	}

	document.addEventListener("DOMContentLoaded", () => {
		const langLinks = document.querySelectorAll("[data-lang-code]")

		langLinks.forEach((link) => {
			link.addEventListener("click", (event) => {
				event.preventDefault()

				const target = event.target
				if (!(target instanceof HTMLElement)) return

				const languageCode = target.dataset.langCode as LanguageCode
				const redirectLink = link.getAttribute("href") || "/"

				if (languageCode) {
					onLanguageSelected(languageCode, redirectLink)
				}
			})
		})
	})
</script>
