---
import { defaultLanguageCode, languageOptions } from "../i18n/ui"
import { getLanguageCodeFromUrl } from "../i18n/utils"
const languageCode = getLanguageCodeFromUrl(Astro.url) || defaultLanguageCode
const otherLanguageCodes = Object.keys(languageOptions).filter(
	(code) => code !== languageCode
)
---

<div class="relative inline-block">
	<details class="cursor-pointer language-selector">
		<summary class="list-none flex items-center gap-1">
			<span>{languageCode.toUpperCase()}</span>
			<svg
				width="10"
				height="6"
				viewBox="0 0 10 6"
				class="dropdown-arrow"
			>
				<path
					d="M1 1L5 5L9 1"
					stroke="currentColor"
					stroke-width="1.5"
					fill="none"></path>
			</svg>
		</summary>
		<ul
			class="absolute mt-2 left-0 bg-white dark:bg-gray-800 shadow-lg rounded py-1 min-w-[100px] z-10"
		>
			{
				otherLanguageCodes.map((code) => (
					<li>
						<a
							href={`/${code}/`}
							class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition"
							data-lang-code={code}
						>
							{code.toUpperCase()}
						</a>
					</li>
				))
			}
		</ul>
	</details>
</div>

<script>
	import { setCookie } from "../utils/cookie"

	document.addEventListener("DOMContentLoaded", () => {
		const langSelector = document.querySelector(".language-selector")
		const langLinks = document.querySelectorAll("[data-lang-code]")

		if (langSelector) {
			document.addEventListener("click", (event) => {
				if (
					!(event.target instanceof Node) ||
					!langSelector.contains(event.target)
				) {
					langSelector.removeAttribute("open")
				}
			})
		}

		langLinks.forEach((link) => {
			const element = link as HTMLElement
			element.addEventListener("click", (event) => {
				event.preventDefault()

				const url = element.getAttribute("href") || "/"
				const langCode = element.dataset.langCode

				if (langCode) {
					setCookie("lang", langCode)
					document.documentElement.lang = langCode
					window.location.href = url
				}
			})
		})
	})
</script>
